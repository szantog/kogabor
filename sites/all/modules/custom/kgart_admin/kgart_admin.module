<?php

/**
 * @file
 *   Custom administration pages and functions for Kovács Gábor gyűjtemény site.
 *   Project:Young Element
 *
 * @developers:
 *    Gabor Szanto <hello@szantogabor.com>
 *    http://szantogabor.com
 *
 */

/**
 * Implementation of hook_boot().
 */
function kgart_admin_boot() {
  global $conf;
  $conf['i18n_variables'] = array(
    // Site name, slogan, mission, etc..
    'site_name',
    'site_slogan',
    'site_mission',
    'site_footer',
    'nodeformscols_field_placements_exhibition_default',
  );
}

/**
 * Implementation of hook_init().
 */
function kgart_admin_init() {
  global $language;
  if (user_access('administer content types') && arg(2) == 'node-type' && arg(4) == 'form' && $language != language_default()) {
    drupal_set_message(t('This form could save only on <strong>the default</strong> language! If need some fix, use _form_alter, look at kgart_admin module!'), 'warning');
  }
}

/**
 * Implementation of hook_menu().
 *
 * @return An array of menu items.
 */
function kgart_admin_menu() {
  $items = array();

  $items['content-admin/site_defaults'] = array(
    'title' => 'Site default settings',
    'description' => 'description',
    'page callback' => 'kgart_admin_page',
    //'page arguments' => array('callback_arg'),
    'access arguments' => array('administer site configuration'),
    'file' => 'includes/kgart_admin.pages.inc',
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Implementation of hook_form_alter().
 */
function kgart_admin_form_alter(&$form, $form_state, $form_id) {
  //dsm($form_id);
  global $language;
  if ($form_id == 'nodeformcols_configuration_form' && $language != language_default()) {
    unset($form['submit']);
  }

  if ($form['#id'] == 'node-form') {
    $type = $form['type']['#value'] ;
    $type_name = check_plain(node_get_types('name', $type));
    $node = $form['#node'];

    if ($type == 'art') {
      //we need manually short some elements.
      $form['#after_build'][] = 'kgart_admin_move_node_options';
    }

    //Add nid to node forms
    $form['show_nid'] = array (
      '#prefix' => '<div id="show-nid" class="form-item">',
      '#suffix' => '</div>',
      '#value' => '<label>' . t('@type ID', array('@type' => t($type_name))) . ': </label>' . $node->nid,
      '#type' => 'markup',
      '#weight' => -1000,
    );

    //@todo This is a tmp solution to put country field via noderef to form
    //By default the fields attaced by views_attach couldn't ordered on node type manage form fields
    //When create an empty array to this form item, de nfc can save it's variable.
    if (($node->type == 'museum') && !isset($form['node_ref_subfield_node_content_1'])) {
      $form['node_ref_subfield_node_content_1'] = array();
    }
    if (($node->type == 'exhibition') && !isset($form['node_ref_subfield_node_content_2'])) {
      $form['node_ref_subfield_node_content_2'] = array();

      //If you doesn't want default value, you have to set this field "Not required" on cck form, then use _form_alter to set up required
      $form['field_exhibition_museum']['#required'] = TRUE;

      if (user_access('administer content types')) {
        $form['field_exhibition_museum']['#suffix'] = '<div class="description">' . t('Admin warning: If you doesn\'t want default value, you have to set this field "Not required" on cck form, then use _form_alter to set up required') . '</div>';
      }
    }

    //Manual weight overrides because of nodeformcols and ipetranslation conflict

    //Tmp doesn't used
    if ($language->language == 'hu') {
      //$form['#after_build'][] = 'kgart_admin_set_field_hu_weight';
    }
    //dsm(get_defined_vars());
  }
}

/*
 * After build function for art_object_node_form
 */
function kgart_admin_move_node_options($form, &$form_state) {
  unset ($form['flag']['#sorted']);
  //Just inherit the original node options elementes, need to insert to flag fieldset
  //Then unset the original node options. The new elements in flag fieldset doesn't have #tree = TRUE, so the $form_state['values'] stay as original.

  $form['flag']['status'] = $form['options']['status'];
  $form['flag']['promote'] = $form['options']['promote'];

  $form['flag']['status']['#description'] = t('(This content appears on front)');
  $form['flag']['promote']['#description'] = t('(Deprecated if Kovács Gábor\'s collection)');

  unset ($form['options']['status']);
  unset ($form['options']['promote']);

  //Short flags
  if (isset($form['flag']['protected'])) {
    $form['flag']['protected']['#weight'] = 1;
  }
  if (isset($form['flag']['sold'])) {
    $form['flag']['sold']['#weight'] = 2;
  }
  if (isset($form['flag']['new_picture'])) {
    $form['flag']['new_picture']['#weight'] = 3;
  }
  $form['flag']['status']['#weight'] = 5;
  $form['flag']['promote']['#weight'] = 4;


  $form['field_art_date'][0]['value2']['#suffix'] = '<div class="description">' . t('does not appear on front, it\'s only used for searching') . '</div>';

  //Add separators
  $form['field_art_insurance']['#suffix'] = '<div class="separator"></div>';
  $form['field_art_purchase_note']['#suffix'] = '<div class="separator"></div>';
  $form['field_art_reproduced']['#suffix'] = '<div class="separator"></div>';
  $form['field_art_image_note']['#suffix'] = '<div class="separator"></div>';
  $form['field_art_state']['#suffix'] = '<div class="separator"></div>';
  $form['group_exhibition']['#suffix'] = '</div><div class="separator"></div>';

  //hide the translation settings field
  $form['translation']['#access'] = FALSE;

  //Hide the form options fieldset if user doesn't acces form element sticky.
  //The others are mived to flag, so it's an empty fieldset in this case.
  if($form['options']['sticky']['#access'] == FALSE) {
    $form['options']['#access'] = FALSE;
  }
  //dsm(get_defined_vars());
  return $form;
}

function kgart_admin_set_field_hu_weight($form, &$form_state) {
  $form['#sorted'] = FALSE;
  $form['show_nid']['#weight'] = -110;
  $form['show_nid']['#sorted'] = FALSE;
  $form['title_en']['#sorted'] = FALSE;
  $form['title_en']['#weight'] = 100;
  $form['title_en']['#sorted'] = FALSE;
  $form['title_en']['#weight'] = 101;
  $form['field_exhibition_lead_en']['#sorted'] = FALSE;
  $form['field_exhibition_lead_en']['#weight'] = 110;
  dsm(get_defined_vars());
  return $form;
}